Define SERVER_PORT "80"
Define SERVER_NAME "localhost"
Define DOCUMENT_ROOT "/usr/local/apache2/htdocs"
Define ERROR_LOG "/usr/local/apache2/logs/error.log"
Define ACCESS_LOG "/usr/local/apache2/logs/access.log"

# Timeout settings
Define TIMEOUT "60"
Define KEEP_ALIVE "On"
Define KEEP_ALIVE_TIMEOUT "5"
Define MAX_KEEP_ALIVE_REQUESTS "100"

# Keycloak reverse proxy settings
Define KEYCLOAK_PORT "8080"
Define KEYCLOAK_MANAGEMENT_PORT="9000"
Define X_FORWARDED_PORT "80"
Define X_FORWARDED_PROTO "http"
Define KEYCLOAK_HOST "keycloak"

# Listen on the specified port
Listen ${SERVER_PORT}

# Define the server's document root
DocumentRoot ${DOCUMENT_ROOT}

<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

# Load essential modules
LoadModule dir_module modules/mod_dir.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule log_config_module modules/mod_log_config.so

# Load proxy and related modules
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule headers_module modules/mod_headers.so

<IfModule unixd_module>
    User www-data
    Group www-data
</IfModule>

# Suppress warning about FQDN (Fully Qualified Domain Name)
ServerName ${SERVER_NAME}

# Server admin email (you should replace this with a real email for production)
ServerAdmin admin@localhost

# Enable log settings (custom path can be used for logs)
LogLevel warn
#ErrorLog ${ERROR_LOG}
#CustomLog ${ACCESS_LOG} combined

# Enable log settings with Log Rotation (custom path can be used for logs)
ErrorLog "|/usr/local/apache2/bin/rotatelogs ${ERROR_LOG}.%Y-%m-%d 86400"
CustomLog "|/usr/local/apache2/bin/rotatelogs ${ACCESS_LOG}.%Y-%m-%d 86400" combined

# Secure document root and directory access
<Directory ${DOCUMENT_ROOT}>
    # Prevent access to hidden files (those starting with .)
    Options -Indexes
    AllowOverride None
    Require all granted
</Directory>

# Set reasonable timeouts to prevent hanging requests
Timeout ${TIMEOUT}
KeepAlive ${KEEP_ALIVE}
KeepAliveTimeout ${KEEP_ALIVE_TIMEOUT}
MaxKeepAliveRequests ${MAX_KEEP_ALIVE_REQUESTS}

# Security Enhancements:
# - Disable .htaccess files from being loaded (avoid unnecessary security risks)
<Directory />
    AllowOverride None
    Require all denied
</Directory>

# Disable directory listing for all directories (already done in the DocumentRoot section)
<Directory "/">
    Options -Indexes
</Directory>

# Reverse proxy settings for Keycloak
<VirtualHost *:${SERVER_PORT}>
    ServerName ${SERVER_NAME}

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyPass "/" "http://${KEYCLOAK_HOST}:${KEYCLOAK_PORT}/"
    ProxyPassReverse "/" "http://${KEYCLOAK_HOST}:${KEYCLOAK_PORT}/"

    # Proxy health check and all its sub-paths
    ProxyPass "/health/" "http://${KEYCLOAK_HOST}:${KEYCLOAK_MANAGEMENT_PORT}/health/"
    ProxyPassReverse "/health/" "http://${KEYCLOAK_HOST}:${KEYCLOAK_MANAGEMENT_PORT}/health/"

    <Proxy *>
        Require all granted
    </Proxy>

    # Additional security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</VirtualHost>
