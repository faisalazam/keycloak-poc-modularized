services:
  postgres:
    image: postgres:17.0
    container_name: ${KEYCLOAK_DB_HOST_NAME}
    env_file:
      - ./.env
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_INTERNAL_PORT}" # 5432 already bound error - so using 5433 for now
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER}"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-5} #ignore the intellij error
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - keycloak_network

  # To access the PostgreSQL database using pgAdmin
  pgadmin:
    image: dpage/pgadmin4:8.12
    container_name: ${PGADMIN_HOST_NAME}
    env_file:
      - ./.env
    ports:
      - "${PGADMIN_HTTP_PORT}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
      - ./pgpass:/pgadmin4/pgpass
      - ./servers.json:/pgadmin4/servers.json
    entrypoint: >
      /bin/sh -c "
        cp -f /pgadmin4/pgpass /var/lib/pgadmin/;
        chmod 600 /var/lib/pgadmin/pgpass;
        chown pgadmin:pgadmin /var/lib/pgadmin/pgpass;
        /entrypoint.sh
      "
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - keycloak_network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "80"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-5} #ignore the intellij error

networks:
  keycloak_network:
    driver: bridge  # Creates a new bridge network for this service
    name: keycloak_network  # This will match the name in the main compose file

volumes:
  pgadmin_data:
  postgres_data:
